--- 
title: "Set up R-scripts to run automatically"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Set up R-scripts to run automatically}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(eval = FALSE)
```

## Overview
Automatic running of R-scripts at scheduled times is useful for making routine reports that should be run regularly, for example outbreak reports and extracting data for statistics like the "Skrantesykestatikk". This vignette describes the different steps to set up automatic batch jobs at Windows.

1. [Set up Windows Task Scheduler to run a bat-script](#set-up-windows-task-scheduler)
2. [Write the bat-script that run the R-scripts](#write-the-bat-script)
3. [Write the main R-script](#write-the-main-r-script)
4. [Write the R-script to check the log](#write-the-r-script-to-check-the-log)

## Set up Windows Task Scheduler
You can use the Task Scheduler in Windows to run an R-script automatically. To set up the Task Scheduler, see [Task Scheduler help](https://www.windowscentral.com/how-create-automated-task-using-task-scheduler-windows-10).

Chose Create task (Opprett oppgave) in the action tab and fill in the name of the task. Use a name that is descriptive, we suggest to use similar names for the task, the bat-file (see below) and the main R-script (see below) and fill in a description of the task. For the remaining points you may use the standard selections, i.e. the common user for batch-tasks and run only when the user is logged on. Be aware that this means that you cannot log off when you leave the PC running the batch scripts.

In the tab Triggers (Utløsere), chose new trigger and set up the system of when to run the program. In the tab for Actions (Handlinger), chose new and select the bat-file that starts the R-scripts (see below). We have chosen to put all the batch-scripts in a common subdirectory at C:\. There is usually no need to change the standardsettings of the tabs Conditions (betingelser) and Settings (Innstillinger).

We have a dedicated server to run the batch scripts and we haveuse a dedicated user account to set up and run the tasks. Contact epi to get access to a server to host the script.

## Write the bat-script
The Task manager calls a bat-file to run the R-scripts. We call two R-scripts, the main script that sources all R-scripts to do the job,  and an R-script to check the log after the main script has run and report the status for the running of the main script. 

A typical bat-file can look like this:
```
"C:\Program Files\R\R-4.0.3\bin\x64\R.exe" CMD BATCH "\\fullpath\batch_outbreak.R"
"C:\Program Files\R\R-4.0.3\bin\x64\R.exe" CMD BATCH "\\fullpath\batch_check_log.R"
```

Be aware that if the path names to the R-scripts include spaces, the path name must be enclosed in quotes. 
National characters should be avoided in the path name. If national characters cannot be avoided and the bat-file do not start the R-scripts, this may be due to the national characters. Try the following:

- Identify the code page at the Windows server running the bat-file. 
- Start the bat-file with setting the codepage to the same as the code page for the server where the R-scripts are located. 
- Include the calls to the R-scripts
- End the bat-file by setting the code page back to the original code page. 

The bat-file will then look like this:
```
:: Save the original code page at the server running the script
for /f "tokens=4" %%i in ('chcp') do set codepage=%%i
:: change the code page to the code page of the server with the scripts, for example 850
chcp 850 
:: Run the R-scripts
"C:\Program Files\R\R-4.0.3\bin\x64\R.exe" CMD BATCH "\\fullpath\batch_outbreak.R"
"C:\Program Files\R\R-4.0.3\bin\x64\R.exe" CMD BATCH "\\fullpath\batch_check_log.R"
:: Reset the code page at the server running the script
chcp %codepage%
```


## Write the Main R-script
Give the main script a stable name that is self explanatory. The name of the main script is included in the bat-file command and you prefer to not have to change the bat-file command. An example is batch_outbreak_123_disease_2020.R

The main script sources different R-scripts that does the tasks. The batch script will usually consist of three parts, setting up the R-environment, sourcing R-scripts, and making the end of the script. 

Setting up the R-environment
Attach packages
```{r, include = TRUE} 
# SETTER OPP R-MILJØ ----
## Aktiverer R-pakker ----
library(NVIbatch) 
use_pkg(pkg = c()) 
use_NVIverse(pkg = c()) 
use_pkg(pkg = c("dplyr", "RODBC", "openxlsx", "ISOweek", "sendmailR"))
use_NVIverse("NVIdb")
```

Global variables
```{r, include = TRUE} 
## Paths and filenames ----
domene<-paste0(set_dir_NVI("FAG"), 
               "Tverrfaglig/Tverrfaglig prosjekter/EJP one health/NOVA/WP3 SyS/Task 3.3 Multivariate SyS for FBD/")

## Dagens dato i formatet yyyymmdd til bruk i filnavn
today<-format(Sys.Date(),"%Y%m%d")
``` 

Import support data
```{r, include = TRUE} 
## Henter stottedata ----
# Read translation table for komnr
kommune_fylke <- read_kommune_fylke()
``` 

Source R-scripts 
```{r, include = TRUE} 
# HENTER OG SENDER CAMPYLOBACTER-DATA ----
# Laster data fra EOS MS azure
source(paste0(domene,"Rscripts/","Hent Campylobacter data fra EOS MS azure.R"), encoding = "UTF-8")

# Sender data til NFI
source(paste0(domene,"Rscripts/","Send Campylobacter data to NFI.R"), encoding = "UTF-8")
``` 

Mark the end of the script
```{r, include = TRUE} 
print("Ferdig Batch Campylobacter til NFI")
``` 

## Write the R-script to check the log
The aim of this script is to perform a check if the main script did run, and if not, report the error and warning messages. The script generates an email that is sent to specified persons.

Give the log script a stable name that is self explanatory. The name of the log script is included in the bat-file command and you prefer to not have to change the bat-file command. I prefer to give a name that is built on the main script name, for example batch_outbreak_123_disease_2020_check_log.R.

The check log script will usually consist of five parts, setting up the R-environment, save the log in the archive, check the log for warnings and errors, report the result of the check per email and delete old log files in the archive.

Setting up the R-environment
Attach packages
```{r, include = TRUE} 
library(NVIbatch) 
use_pkg(pkg = c("sendmailR")) 
use_NVIverse(pkg = c("NVIdb")) 
```

Global variables
```{r, include = TRUE} 
# Global variables
# Paths and filenames
domene <- paste0(set_dir_NVI("FAG"), "xxxx")

batch <- "batch_outbreak_123_disease_2020" #= navnet på scriptet som det skal lage logg for

#Dagens dato i formatet yyyymmdd til bruk i filnavn
today <- format(Sys.Date(),"%Y%m%d")
```

Save log in archive
```{r, include = TRUE} 
# SAVE LOG-FILE PER DAY ----
file.copy(from = paste0(domene,"Rscripts/",batch,".Rout"), 
          to = paste0(domene, "batchlogg/", batch, " ", today, ".Rout"))

``` 

Check log for errors and warnings
```{r, include = TRUE} 
messages <- gather_messages(filename = paste0(domene, "Rscripts/", batch, ".Rout"))
``` 

Send email with the results of the check
```{r, include = TRUE} 
#needs full path if not in working directory
attachmentPathName <- paste0(domene, "Rscripts/", batch, ".Rout")
#same as attachmentPath if using working directory
attachmentName <- paste0(batch, ".Rout")
#key part for attachments, put the body and the mime_part in a list for msg
attachmentObject <- mime_part(x = attachmentPathName, name = attachmentName)

# Tar inn feilmeldinger dersom det er noen
if (length(messages)>0) {
  subject <- paste("Feil i", batch)
  body <- list(c("Feilmeldinger", messages), attachmentObject)
} else {
  subject <- paste("Status for", batch)
  body <- list(attachmentObject)
}

# SEND EMAIL ----
sendmail(from = "<epi@vetinst.no>",
         to = c("<Petter.Hopp@vetinst.no>"),
         subject = subject,
         msg = body, 
         control = list(smtpServer="webmail.vetinst.no"))
``` 

Delete archived files
```{r, include = TRUE} 

```

